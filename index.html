<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Quids - Admin Panel</title>
    <style>
        /* CSS for the design shown in screenshot (Top Header, Tabs) */
        :root {
            --primary-color: #5F259F; --primary-color-rgb: 95, 37, 159; --primary-light: #7E57C2; 
            --accent-color: #FFD700; --content-bg: #F4F6FC; --card-bg: #FFFFFF; 
            --text-color: #333D49; --text-light: #6C757D; --text-on-primary: #FFFFFF;
            --success-color: #28A745; --error-color: #DC3545; --info-color: #17A2B8; 
            --warn-color: #FFC107; --border-color: #E0E0E0; --input-bg: #F9FAFB; 
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.07); --font-family: 'Roboto', 'Segoe UI', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: var(--content-bg); color: var(--text-color); font-size: 15px; line-height: 1.5; }
        .admin-login-container { display: flex; justify-content: center; align-items: center; width: 100%; min-height: 100vh; background: var(--primary-color); }
        .login-box { background-color: var(--card-bg); padding: 30px 35px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .login-box h1 { color: var(--primary-color); font-size: 1.8em; margin-bottom: 25px; font-weight: 700; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; font-size: 0.9em; font-weight: 500; color: var(--text-light); margin-bottom: 8px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; color: var(--text-color); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.2); }
        .admin-form textarea { min-height: 80px;}
        .btn { display: inline-block; padding: 12px 25px; background: var(--primary-color); color: var(--text-on-primary); border: none; border-radius: 8px; font-size: 1em; font-weight: 500; cursor: pointer; text-align: center; transition: background-color 0.2s ease, transform 0.1s ease; }
        .btn:hover { background-color: var(--primary-color-dark); }
        .btn:active { transform: scale(0.98); }
        #adminLoginError { color: var(--error-color); font-size: 0.9em; margin-top: 15px; display: none; }
        .admin-dashboard-layout { width: 100%; min-height: 100vh; display:flex; flex-direction:column; }
        .admin-top-header { background-color: var(--primary-color); padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.15); position:sticky; top:0; z-index:1001; }
        .admin-top-header h1 { font-size: 1.4em; color: var(--text-on-primary); margin: 0; font-weight: 500; }
        #adminLogoutBtn { background-color: rgba(255,255,255,0.2); color: var(--text-on-primary); padding: 7px 15px; font-size: 0.9em; border-radius: 6px; }
        #adminLogoutBtn:hover { background-color: rgba(255,255,255,0.3); }
        .admin-nav-tabs { display: flex; background-color: var(--primary-color-dark); box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow-x: auto; }
        .admin-nav-tab { padding: 12px 18px; color: rgba(255,255,255,0.75); cursor: pointer; font-weight: 500; border-bottom: 3px solid transparent; transition: color 0.2s, border-bottom-color 0.2s, background-color 0.2s; white-space: nowrap; font-size: 0.9em; }
        .admin-nav-tab:hover { background-color: var(--primary-light); color: var(--text-on-primary); }
        .admin-nav-tab.active { color: var(--text-on-primary); border-bottom-color: var(--accent-color); background-color: var(--primary-light); font-weight: 600; }
        .admin-main-content { padding: 25px; flex-grow: 1; }
        .admin-section { display: none; animation: fadeInContent 0.3s ease-out; }
        .admin-section.active { display: block; }
        @keyframes fadeInContent { from{opacity:0; transform: translateY(5px);} to{opacity:1; transform:translateY(0);} }
        .section-title-header { font-size: 1.7em; color: var(--primary-color); margin-bottom: 20px; font-weight: 600; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .filters-bar { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; padding: 15px; background-color:var(--card-bg); border-radius:8px; box-shadow: var(--shadow); }
        .filters-bar input[type="text"], .filters-bar select { padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9em; flex-grow:1; background-color: var(--input-bg); }
        .filters-bar label { display: flex; align-items: center; font-size: 0.9em; } .filters-bar input[type="checkbox"] { margin-right: 5px; accent-color: var(--primary-color); }
        .table-container { background-color: var(--card-bg); border-radius: 8px; box-shadow: var(--shadow); overflow-x:auto; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .data-table th, .data-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle;}
        .data-table thead th { background-color: #F1F3F5; color: var(--text-light); font-weight: 500; font-size: 0.85em; text-transform: uppercase; }
        .data-table tbody tr:hover { background-color: #f8f9fa; }
        .action-btn { padding: 5px 10px; font-size:0.8em; margin-right:5px; border-radius:5px; cursor:pointer; border:none; color:white; }
        .btn-info { background-color: var(--info-color); } .btn-info:hover { background-color: #117a8b;}
        .btn-success { background-color: var(--success-color); } .btn-success:hover { background-color: #1e7e34;}
        .btn-danger { background-color: var(--error-color); } .btn-danger:hover { background-color: #bd2130;}
        .btn-warn { background-color: var(--warn-color); color:var(--text-color);} .btn-warn:hover { background-color: #e0a800;}
        .status-pill { padding: 3px 8px; border-radius: 15px; font-size: 0.8em; font-weight: 500; display: inline-block; text-align: center; min-width: 80px; }
        .status-pill.active, .status-pill.approved { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;}
        .status-pill.blocked, .status-pill.rejected { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
        .status-pill.under-process { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;}
        .status-pill.new-message { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;}
        .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--card-bg); margin: auto; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 100%; max-width: 700px; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .modal-header h3 { margin: 0; color: var(--primary-color); font-size: 1.3em; font-weight: 600; }
        .modal-close-btn { font-size: 1.8em; font-weight: bold; color: var(--text-light); background: none; border: none; cursor: pointer; line-height: 1; padding: 5px; }
        .modal-close-btn:hover { color: var(--text-color); }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px 20px; font-size:0.95em; }
        .detail-item p { margin-bottom: 7px; word-break: break-word; } .detail-item strong { font-weight: 500; color: var(--text-light); margin-right:5px; }
        #adminSupportChatView { display: flex; flex-direction: column; height: 60vh; }
        #adminChatMessagesArea { flex-grow: 1; overflow-y: auto; padding: 15px; background-color: var(--content-bg); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px; }
        #adminSupportChatView .chat-message { padding: 8px 12px; border-radius: 15px; margin-bottom: 10px; max-width: 75%; word-wrap: break-word; font-size: 0.9em; line-height: 1.4; }
        #adminSupportChatView .chat-message.admin { background-color: var(--primary-color); color: var(--text-on-primary); margin-left: auto; border-bottom-right-radius: 5px; }
        #adminSupportChatView .chat-message.user { background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); margin-right: auto; border-bottom-left-radius: 5px; }
        #adminSupportChatView .chat-message .timestamp { font-size: 0.75em; display: block; text-align: right; margin-top: 4px; opacity: 0.8; }
        #adminChatForm { display: flex; align-items: center; }
        #adminChatMessageInput { flex-grow: 1; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 20px; margin-right: 10px; font-size: 0.95em; }
        #adminChatForm button { padding: 10px 15px; border-radius: 20px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; display: none; backdrop-filter: blur(2px); }
        .loading-spinner { border: 5px solid rgba(var(--primary-color-rgb),0.2); border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast-notification { position: fixed; top: 20px; right: 20px; background-color: var(--text-color); color: var(--text-on-primary); padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); z-index: 10000; font-size: 0.9em; opacity: 0; transform: translateY(-20px) ; transition: opacity 0.3s ease, transform 0.3s ease; }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .toast-notification.success { background-color: var(--success-color); } .toast-notification.error { background-color: var(--error-color); } .toast-notification.info { background-color: var(--info-color); }
        .admin-form { padding-top: 10px; }
        .admin-form .form-group label {color: var(--text-light); font-weight:400;}
        @media (max-width: 768px) { .admin-nav-tabs { font-size: 0.85em; } .admin-nav-tab { padding: 12px 10px; } .admin-main-content { padding: 15px; } .section-title-header { font-size: 1.5em; } .filters-bar { flex-direction: column; gap: 10px; } .filters-bar input[type="text"], .filters-bar select { width:100%;} }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="adminLoginScreen" class="admin-login-container screen active">
        <div class="login-box">
            <h1>Admin Panel</h1>
            <form id="adminLoginForm">
                <div class="form-group"><label for="adminLoginEmail">Email Address</label><input type="email" id="adminLoginEmail" required autocomplete="username"></div>
                <div class="form-group"><label for="adminLoginPassword">Password</label><input type="password" id="adminLoginPassword" required autocomplete="current-password"></div>
                <button type="submit" class="btn" style="width:100%;">Login</button>
                <p id="adminLoginError"></p>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard Layout -->
    <div id="adminDashboardLayout" class="admin-dashboard-layout screen">
        <header class="admin-top-header">
            <h1>Quick Quids Admin</h1>
            <button id="adminLogoutBtn" class="btn btn-sm">Logout</button>
        </header>
        <nav class="admin-nav-tabs" id="adminNavTabs">
            <span class="admin-nav-tab active" data-section="usersSection">Users</span>
            <span class="admin-nav-tab" data-section="loanRequestsSection">Loan Requests</span>
            <span class="admin-nav-tab" data-section="activeLoansSection">Active Loans</span>
            <span class="admin-nav-tab" data-section="blockedUsersSection">Blocked Users</span>
            <span class="admin-nav-tab" data-section="paymentMethodsSection">Payment Methods</span>
            <span class="admin-nav-tab" data-section="supportRequestsSection">Support Requests</span>
        </nav>
        <main class="admin-main-content">
            <section id="usersSection" class="admin-section active">
                <h2 class="section-title-header">User Management</h2>
                <div class="filters-bar"><input type="text" id="userSearchInput" placeholder="Search by Name, Email, UID..."></div>
                <div class="table-container"><table class="data-table" id="usersTable"><thead><tr><th>UID</th><th>Full Name</th><th>Email</th><th>Mobile</th><th>Status</th><th>Actions</th></tr></thead><tbody><tr><td colspan="6" style="text-align:center; padding:20px;">Loading users...</td></tr></tbody></table></div>
            </section>
            <section id="loanRequestsSection" class="admin-section">
                <h2 class="section-title-header">Loan Application Requests</h2>
                <div class="filters-bar"><input type="text" id="loanRequestSearchInput" placeholder="Search by Applicant, Email, Loan ID..."><select id="loanStatusFilter"><option value="all">All Statuses</option><option value="Under Process">Under Process</option><option value="Approved">Approved</option><option value="Rejected">Rejected</option></select><label><input type="checkbox" id="onlyPendingReviewFilter"> Only Pending Review</label></div>
                <div class="table-container"><table class="data-table" id="loanRequestsTable"><thead><tr><th>Loan ID</th><th>Applicant</th><th>Type</th><th>Amount (₹)</th><th>Fee TxID</th><th>Applied</th><th>Status</th><th>Actions</th></tr></thead><tbody><tr><td colspan="8" style="text-align:center; padding:20px;">Loading requests...</td></tr></tbody></table></div>
            </section>
            <section id="activeLoansSection" class="admin-section">
                <h2 class="section-title-header">Active Loans Monitoring</h2>
                <div class="filters-bar"><input type="text" id="activeLoanSearchInput" placeholder="Search by Applicant, Loan ID..."></div>
                <div class="table-container"><table class="data-table" id="activeLoansTable"><thead><tr><th>Loan ID</th><th>Applicant</th><th>Type</th><th>Approved (₹)</th><th>EMI/Total (₹)</th><th>Next Due</th><th>Overall Status</th></tr></thead><tbody><tr><td colspan="7" style="text-align:center; padding:20px;">Loading active loans...</td></tr></tbody></table></div>
            </section>
            <section id="blockedUsersSection" class="admin-section">
                <h2 class="section-title-header">Blocked Users</h2>
                <div class="filters-bar"><input type="text" id="blockedUserSearchInput" placeholder="Search by Name, Email, UID..."></div>
                <div class="table-container"><table class="data-table" id="blockedUsersTable"><thead><tr><th>UID</th><th>Full Name</th><th>Email</th><th>Reason</th><th>Actions</th></tr></thead><tbody><tr><td colspan="5" style="text-align:center; padding:20px;">Loading blocked users...</td></tr></tbody></table></div>
            </section>
            <section id="paymentMethodsSection" class="admin-section">
                <h2 class="section-title-header">Payment Method Configuration</h2>
                <form id="paymentMethodsForm" class="admin-form" style="max-width:600px; background:var(--card-bg); padding:20px; border-radius:8px; box-shadow:var(--shadow);">
                    <p style="color:var(--text-light); font-size:0.9em; margin-bottom:15px;">These details appear on the user panel for processing fee payment.</p>
                    <div class="form-group"><label for="upiIdInput">UPI ID</label><input type="text" id="upiIdInput" required></div>
                    <div class="form-group"><label for="bankDetailsInput">Bank Account Details (Acct Name, Number, IFSC)</label><textarea id="bankDetailsInput" rows="3" required></textarea></div>
                    <button type="submit" class="btn">Save Payment Methods</button>
                    <div id="paymentMethodsPreview" style="margin-top:20px; padding:15px; background-color:#f8f9fa; border:1px dashed var(--border-color); border-radius:8px;">
                        <h4 style="margin-bottom:10px; font-weight:500;">Preview (User View):</h4>
                        <p><strong>UPI:</strong> <span id="previewUpiId">Not set</span></p>
                        <p><strong>Bank:</strong> <span id="previewBankDetails">Not set</span></p>
                    </div>
                </form>
            </section>
            <section id="supportRequestsSection" class="admin-section">
                <h2 class="section-title-header">Customer Support Requests</h2>
                <div class="filters-bar"><input type="text" id="supportSearchInput" placeholder="Search by User Name, User ID..."><label><input type="checkbox" id="unreadByAdminFilter"> Only Unread by Admin</label></div>
                <div class="table-container"><table class="data-table" id="supportRequestsTable"><thead><tr><th>User Name</th><th>Last Message</th><th>Timestamp</th><th>Status</th><th>Actions</th></tr></thead><tbody><tr><td colspan="5" style="text-align:center; padding:20px;">Loading support requests...</td></tr></tbody></table></div>
            </section>
        </main>
    </div>

    <div id="adminModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 id="adminModalTitle"></h3><button class="modal-close-btn" id="adminModalCloseBtn">&times;</button></div><div id="adminModalBody"></div></div></div>
    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>
    <div class="toast-notification" id="toastNotification"></div>

    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut as firebaseSignOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, query, where, orderBy, Timestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";
        import { getDatabase, ref, get, set, push, onValue, serverTimestamp, query as rtdbQuery, orderByChild as rtdbOrderByChild, update as rtdbUpdate } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5lWYt4OTJLwWCrcBFs2YuFjMSGBfmWFs", authDomain: "quickquids1.firebaseapp.com",
            databaseURL: "https://quickquids1-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "quickquids1",
            storageBucket: "quickquids1.firebasestorage.app", messagingSenderId: "536263689144",
            appId: "1:536263689144:web:276640940106438cf8454d", measurementId: "G-7SEB49V2LL"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        // DOM Elements
        const adminLoginScreen = document.getElementById('adminLoginScreen');
        const adminDashboardLayout = document.getElementById('adminDashboardLayout');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const adminLoginEmailInput = document.getElementById('adminLoginEmail');
        const adminLoginPasswordInput = document.getElementById('adminLoginPassword');
        const adminLoginError = document.getElementById('adminLoginError');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const adminNavTabs = document.querySelectorAll('.admin-nav-tab');
        const adminSections = document.querySelectorAll('.admin-section');
        const usersTableBody = document.querySelector('#usersTable tbody');
        const userSearchInput = document.getElementById('userSearchInput');
        const loanRequestsTableBody = document.querySelector('#loanRequestsTable tbody');
        const loanRequestSearchInput = document.getElementById('loanRequestSearchInput');
        const loanStatusFilter = document.getElementById('loanStatusFilter');
        const onlyPendingReviewFilter = document.getElementById('onlyPendingReviewFilter');
        const activeLoansTableBody = document.querySelector('#activeLoansTable tbody');
        const activeLoanSearchInput = document.getElementById('activeLoanSearchInput');
        const blockedUsersTableBody = document.querySelector('#blockedUsersTable tbody');
        const blockedUserSearchInput = document.getElementById('blockedUserSearchInput');
        const paymentMethodsForm = document.getElementById('paymentMethodsForm');
        const upiIdInput = document.getElementById('upiIdInput');
        const bankDetailsInput = document.getElementById('bankDetailsInput');
        const previewUpiId = document.getElementById('previewUpiId');
        const previewBankDetails = document.getElementById('previewBankDetails');
        const supportRequestsTableBody = document.querySelector('#supportRequestsTable tbody');
        const supportSearchInput = document.getElementById('supportSearchInput');
        const unreadByAdminFilter = document.getElementById('unreadByAdminFilter');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const toastNotification = document.getElementById('toastNotification');
        const adminModal = document.getElementById('adminModal');
        const adminModalTitle = document.getElementById('adminModalTitle');
        const adminModalBody = document.getElementById('adminModalBody');
        const adminModalCloseBtn = document.getElementById('adminModalCloseBtn');

        let currentAdminUser = null;
        let currentOpenSection = 'usersSection'; 
        let listeners = { users: null, paymentMethods: null, supportRequests: null, currentChat: null };

        // --- Utility Functions ---
        function showLoading(show = true) { loadingOverlay.style.display = show ? 'flex' : 'none'; }
        function showToast(message, duration = 3000, type = 'info') {
            toastNotification.textContent = message; toastNotification.className = 'toast-notification'; 
            if (type) toastNotification.classList.add(type);
            toastNotification.classList.add('show'); setTimeout(() => toastNotification.classList.remove('show'), duration);
        }
        function openModal(title, contentHtml) { 
            if(adminModalTitle) adminModalTitle.textContent = title; 
            if(adminModalBody) adminModalBody.innerHTML = contentHtml; 
            if(adminModal) adminModal.classList.add('active'); 
        }
        function closeModal() { 
            if(adminModal) adminModal.classList.remove('active'); 
            if(adminModalBody) adminModalBody.innerHTML = ''; 
            if(listeners.currentChat) { try { listeners.currentChat(); listeners.currentChat=null; } catch(e){console.warn("Chat listener unsub error",e)} }
        }
        adminModalCloseBtn?.addEventListener('click', closeModal);
        adminModal?.addEventListener('click', (e) => { if (e.target === adminModal) closeModal(); });
        
        function cleanupListeners() {
            Object.keys(listeners).forEach(key => {
                if (listeners[key]) { try { listeners[key](); listeners[key] = null; } catch(e){ console.warn(`Error unsubscribing ${key}:`, e); }}
            });
        }

        function switchSection(sectionId) {
            cleanupListeners(); 
            currentOpenSection = sectionId;
            adminSections.forEach(s => s.classList.remove('active'));
            const targetSection = document.getElementById(sectionId);
            if(targetSection) targetSection.classList.add('active'); else { console.error("Target section not found:", sectionId); return; }

            adminNavTabs.forEach(tab => tab.classList.remove('active'));
            const activeTab = document.querySelector(`.admin-nav-tab[data-section="${sectionId}"]`);
            if(activeTab) activeTab.classList.add('active');
            
            if (sectionId === 'usersSection') loadUsersWithListener();
            else if (sectionId === 'loanRequestsSection') loadLoanRequests();
            else if (sectionId === 'activeLoansSection') loadActiveLoans();
            else if (sectionId === 'blockedUsersSection') loadBlockedUsers();
            else if (sectionId === 'paymentMethodsSection') loadPaymentMethodsWithListener();
            else if (sectionId === 'supportRequestsSection') loadSupportRequestsWithListener();
        }

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            showLoading();
            if (user) {
                try {
                    const idTokenResult = await user.getIdTokenResult(true); 
                    if (idTokenResult.claims.admin === true) {
                        currentAdminUser = user;
                        adminLoginScreen.classList.remove('active'); adminDashboardLayout.classList.add('active');
                        switchSection('usersSection'); 
                        showToast(`Welcome Admin!`, 2000, 'success');
                    } else {
                        await firebaseSignOut(auth); 
                        if(adminLoginError) {adminLoginError.textContent = "Access Denied. Not an authorized admin."; adminLoginError.style.display = 'block';}
                        adminDashboardLayout.classList.remove('active'); adminLoginScreen.classList.add('active');
                    }
                } catch (error) {
                     console.error("Admin claim check or signout error:", error); 
                     try { await firebaseSignOut(auth); } catch(e) { console.warn("Secondary signout attempt failed", e); }
                     if(adminLoginError){adminLoginError.textContent = "Error verifying admin status. Please login again."; adminLoginError.style.display = 'block';}
                     adminDashboardLayout.classList.remove('active'); adminLoginScreen.classList.add('active');
                }
            } else {
                currentAdminUser = null; cleanupListeners();
                adminDashboardLayout.classList.remove('active'); adminLoginScreen.classList.add('active');
                if(adminLoginForm) adminLoginForm.reset();
            }
            showLoading(false);
        });
        adminLoginForm?.addEventListener('submit', async (e) => {
            e.preventDefault(); showLoading(); if(adminLoginError) adminLoginError.style.display = 'none';
            const email = adminLoginEmailInput.value; const password = adminLoginPasswordInput.value;
            if (!email || !password) { if(adminLoginError){ adminLoginError.textContent = "Email and Password are required."; adminLoginError.style.display = 'block';} showLoading(false); return; }
            try { await signInWithEmailAndPassword(auth, email, password); }
            catch (error) {
                if(adminLoginError) {
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') adminLoginError.textContent = "Invalid admin credentials.";
                    else if (error.code === 'auth/too-many-requests') adminLoginError.textContent = "Access temporarily disabled. Try again later.";
                    else adminLoginError.textContent = `Login Failed. Please check credentials. (${error.code})`;
                    adminLoginError.style.display = 'block';
                }
                console.error("Admin Login Error:", error);
            }
            showLoading(false);
        });
        adminLogoutBtn?.addEventListener('click', async () => { showLoading(); try { await firebaseSignOut(auth); } catch (e) { showToast(`Logout Failed: ${e.message}`, 3000, 'error'); showLoading(false); }});
        adminNavTabs.forEach(tab => { tab.addEventListener('click', () => switchSection(tab.dataset.section)); });

        // --- User Management (Realtime with onSnapshot) ---
        function loadUsersWithListener() {
            if (listeners.users) listeners.users(); 
            showLoading();
            if(!usersTableBody) { showLoading(false); console.error("usersTableBody not found"); return; }
            usersTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Loading users...</td></tr>';
            
            const usersRef = query(collection(db, "users"), orderBy("createdAt", "desc"));
            listeners.users = onSnapshot(usersRef, (querySnapshot) => {
                let users = []; querySnapshot.forEach(doc => users.push({ id: doc.id, ...doc.data() }));
                const searchTerm = userSearchInput ? userSearchInput.value.toLowerCase() : '';
                if (searchTerm) { users = users.filter(u => u.fullName?.toLowerCase().includes(searchTerm) || u.email?.toLowerCase().includes(searchTerm) || u.id.toLowerCase().includes(searchTerm)); }
                renderUsersTable(users);
                showLoading(false);
            }, (error) => { 
                console.error("Users listener error:", error); 
                if(usersTableBody) usersTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Error loading users. Check console/Firestore rules.</td></tr>';
                showToast("Error loading users. Firestore rules or index might be an issue.", 5000, "error"); showLoading(false); 
            });
        }
        userSearchInput?.addEventListener('input', () => loadUsersWithListener());

        function renderUsersTable(users) { 
            if(!usersTableBody) return; usersTableBody.innerHTML = '';
            if (users.length === 0) { usersTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No users found.</td></tr>'; return; }
            users.forEach(user => {
                const row = usersTableBody.insertRow();
                row.innerHTML = `<td>${user.id.substring(0,8)}..</td><td>${user.fullName||'N/A'}</td><td>${user.email}</td><td>${user.mobile||'N/A'}</td><td><span class="status-pill ${user.isBlocked ? 'blocked' : 'active'}">${user.isBlocked ? 'Blocked' : 'Active'}</span></td>
                <td class="action-buttons-group"><button class="action-btn btn-info" onclick="viewUserDetails('${user.id}')">Details</button><button class="action-btn ${user.isBlocked ? 'btn-success' : 'btn-warn'}" onclick="toggleUserBlockStatus('${user.id}', ${user.isBlocked ?? false})">${user.isBlocked ? 'Unblock' : 'Block'}</button></td>`;
            });
        }
        window.viewUserDetails = async (userId) => {
            showLoading();
            try {
                const userDocSnap = await getDoc(doc(db, "users", userId));
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    let detailsHtml = `<div class="detail-grid">
                        <div class="detail-item"><p><strong>UID:</strong> ${userId}</p></div>
                        <div class="detail-item"><p><strong>Full Name:</strong> ${userData.fullName || 'N/A'}</p></div>
                        <div class="detail-item"><p><strong>Email:</strong> ${userData.email}</p></div>
                        <div class="detail-item"><p><strong>Mobile:</strong> ${userData.mobile || 'N/A'}</p></div>
                        <div class="detail-item"><p><strong>Birth Year:</strong> ${userData.birthYear || 'N/A'}</p></div>
                        <div class="detail-item"><p><strong>Gender:</strong> ${userData.gender || 'N/A'}</p></div>
                        <div class="detail-item"><p><strong>Joined:</strong> ${userData.createdAt?.toDate().toLocaleString() || 'N/A'}</p></div>
                        <div class="detail-item"><p><strong>Status:</strong> ${userData.isBlocked ? 'Blocked' : 'Active'}</p></div>
                        ${userData.isBlocked && userData.blockReason ? `<div class="detail-item" style="grid-column: 1 / -1;"><p><strong>Block Reason:</strong> ${userData.blockReason}</p></div>` : ''}
                    </div>`;
                    openModal(`User Details: ${userData.fullName || userId.substring(0,8)}`, detailsHtml);
                } else { showToast("User not found.", 3000, 'error'); }
            } catch (error) { console.error("View user details error:", error); showToast("Error fetching user details.", 3000, 'error'); }
            showLoading(false);
        };
        window.toggleUserBlockStatus = async (userId, isCurrentlyBlocked) => {
            const action = isCurrentlyBlocked ? "unblock" : "block";
            let reason = '';
            if (!isCurrentlyBlocked) {
                reason = prompt(`Reason for ${action}ing user ${userId.substring(0,8)}.. (optional):`);
                if (reason === null) return; 
            }
            if (confirm(`Are you sure you want to ${action} user ${userId.substring(0,8)}..?`)) {
                showLoading();
                const newBlockStatus = !isCurrentlyBlocked;
                const updatesFirestore = { isBlocked: newBlockStatus };
                if (reason) updatesFirestore.blockReason = reason;
                else if (isCurrentlyBlocked) updatesFirestore.blockReason = null; 

                const userDocRefFirestore = doc(db, "users", userId);
                const userNodeRefRtdb = ref(rtdb, `users/${userId}`);
                const rtdbUpdates = { isBlocked: newBlockStatus };
                if (updatesFirestore.blockReason !== undefined) rtdbUpdates.blockReason = updatesFirestore.blockReason;
                else if (isCurrentlyBlocked) rtdbUpdates.blockReason = "";


                try {
                    await updateDoc(userDocRefFirestore, updatesFirestore); 
                    await rtdbUpdate(userNodeRefRtdb, rtdbUpdates); 
                    showToast(`User ${action}ed successfully.`, 2000, 'success');
                } catch (error) { showToast(`Failed to ${action} user: ${error.message}`, 3000, 'error'); console.error(error); }
                showLoading(false);
            }
        };

        // --- Loan Requests (getDocs, DUAL WRITE for actions) ---
        async function loadLoanRequests() {
            showLoading();
            if(!loanRequestsTableBody) { showLoading(false); return; }
            loanRequestsTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">Loading requests...</td></tr>';
            
            let q = collection(db, "loanApplications");
            const conditions = [];
            const statusVal = loanStatusFilter ? loanStatusFilter.value : 'all';
            const pendingOnlyVal = onlyPendingReviewFilter ? onlyPendingReviewFilter.checked : false;

            if (statusVal !== 'all') conditions.push(where("status", "==", statusVal));
            if (pendingOnlyVal) conditions.push(where("adminReviewed", "==", false));
            conditions.push(orderBy("appliedAt", "desc")); // Default sort
            
            // Construct query based on conditions
            if (conditions.length > 0) {
                q = query(q, ...conditions);
            } else {
                 q = query(collection(db, "loanApplications"), orderBy("appliedAt", "desc"));
            }


            try {
                const querySnapshot = await getDocs(q);
                let requests = []; querySnapshot.forEach(doc => requests.push({ id: doc.id, ...doc.data() }));
                const searchTerm = loanRequestSearchInput ? loanRequestSearchInput.value.toLowerCase() : '';
                if (searchTerm) { requests = requests.filter(r => r.userName?.toLowerCase().includes(searchTerm) || r.userEmail?.toLowerCase().includes(searchTerm) || r.id.toLowerCase().includes(searchTerm)); }
                renderLoanRequestsTable(requests);
            } catch (error) { 
                console.error("Loan requests error:", error); 
                if(loanRequestsTableBody) loanRequestsTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">Error loading requests. Check console/Firestore index.</td></tr>';
                if (error.code === 'failed-precondition') showToast("Database index missing for loan requests filter/sort. Please create it in Firebase Console.", 5000, "error");
                else showToast("Error loading loan requests.", 3000, "error");
            }
            showLoading(false);
        }
        loanRequestSearchInput?.addEventListener('input', loadLoanRequests);
        loanStatusFilter?.addEventListener('change', loadLoanRequests);
        onlyPendingReviewFilter?.addEventListener('change', loadLoanRequests);

        function renderLoanRequestsTable(requests) {
            if(!loanRequestsTableBody) return; loanRequestsTableBody.innerHTML = '';
            if (requests.length === 0) { loanRequestsTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">No requests match criteria.</td></tr>'; return; }
            requests.forEach(req => {
                const row = loanRequestsTableBody.insertRow();
                const appliedDate = req.appliedAt?.toDate ? req.appliedAt.toDate().toLocaleDateString() : 'N/A';
                row.innerHTML = `
                    <td>${req.id.substring(0,8)}..</td><td>${req.userName || req.userEmail || 'N/A'}</td>
                    <td>${req.loanType || 'N/A'}</td><td>${req.loanAmount?.toLocaleString('en-IN') || 'N/A'}</td>
                    <td>${req.paymentTransactionId || 'N/A'}</td><td>${appliedDate}</td>
                    <td><span class="status-pill ${req.status?.toLowerCase().replace(/\s+/g, '-')}">${req.status || 'N/A'}</span></td>
                    <td class="action-buttons-group">
                        <button class="action-btn btn-info" onclick="viewLoanRequestDetails('${req.id}')">Details</button>
                        ${req.status === 'Under Process' ? `<button class="action-btn btn-success" onclick="processLoanAction('${req.id}', 'Approved')">Approve</button><button class="action-btn btn-danger" onclick="processLoanAction('${req.id}', 'Rejected')">Reject</button>` : ''}
                    </td>`;
            });
        }
        window.viewLoanRequestDetails = async (loanId) => {
             showLoading();
            try {
                const loanDoc = await getDoc(doc(db, "loanApplications", loanId));
                if (loanDoc.exists()) {
                    const loan = loanDoc.data();
                    let detailsHtml = `<div class="detail-grid">
                        <div class="detail-item"><p><strong>Loan ID:</strong> ${loanId}</p></div>
                        <div class="detail-item"><p><strong>Applicant:</strong> ${loan.userName || loan.userEmail} (UID: ${loan.userId})</p></div>
                        <div class="detail-item"><p><strong>Type:</strong> ${loan.loanType === 'personal' ? 'Personal Loan' : 'Credit Limit'}</p></div>
                        <div class="detail-item"><p><strong>Amount Req.:</strong> ₹${loan.loanAmount?.toLocaleString('en-IN') || 'N/A'}</p></div>
                        <div class="detail-item"><p><strong>Tenure Req.:</strong> ${loan.tenure || 'N/A'}</p></div>
                        <div class="detail-item"><p><strong>Calculated:</strong> ${loan.calculatedEmiOrTotal || 'N/A'}</p></div>
                        <div class="detail-item"><p><strong>Applied On:</strong> ${loan.appliedAt?.toDate().toLocaleString() || 'N/A'}</p></div>
                        <div class="detail-item"><p><strong>Status:</strong> ${loan.status || 'N/A'}</p></div>
                        <div class="detail-item"><p><strong>Aadhaar:</strong> ${loan.aadhaarNumber || 'N/A'}</p></div>
                        <div class="detail-item"><p><strong>PAN:</strong> ${loan.panNumber || 'N/A'}</p></div>
                        <div class="detail-item" style="grid-column: 1 / -1;"><p><strong>Address:</strong> ${loan.address?.line1}, ${loan.address?.city}, ${loan.address?.state} - ${loan.address?.pincode}</p></div>
                        <div class="detail-item"><p><strong>Employment:</strong> ${loan.employmentType || 'N/A'}</p></div>
                        <div class="detail-item"><p><strong>Purpose:</strong> ${loan.loanPurpose || 'N/A'}</p></div>
                        <div class="detail-item"><p><strong>Processing Fee TxID:</strong> ${loan.paymentTransactionId || 'N/A'}</p></div>
                        <div class="detail-item"><p><strong>Credit Consent:</strong> ${loan.creditCheckConsent ? 'Yes' : 'No'}</p></div>
                        ${loan.rejectionReason ? `<div class="detail-item" style="grid-column: 1 / -1;"><p><strong>Rejection Reason:</strong> ${loan.rejectionReason}</p></div>` : ''}
                    </div>`;
                    if (loan.status === 'Approved') {
                        detailsHtml += `<h4 style="margin-top:20px; margin-bottom:10px; color:var(--primary-color);">Approved Loan Details:</h4><div class="detail-grid">`;
                        if(loan.loanType === 'personal' && loan.emiSchedule) {
                            detailsHtml += `<div class="detail-item"><p><strong>Monthly EMI:</strong> ${loan.emiSchedule.monthlyEMI}</p></div>
                                          <div class="detail-item"><p><strong>Tenure:</strong> ${loan.emiSchedule.tenureMonths} months</p></div>
                                          <div class="detail-item"><p><strong>Start Date:</strong> ${loan.emiSchedule.startDate || 'N/A'}</p></div>
                                          <div class="detail-item"><p><strong>Next Due:</strong> ${loan.emiSchedule.nextDueDate || 'N/A'}</p></div>`;
                        } else if (loan.loanType === 'credit' && loan.repaymentDetails) {
                            detailsHtml += `<div class="detail-item"><p><strong>Total Due:</strong> ${loan.repaymentDetails.totalAmount}</p></div>
                                          <div class="detail-item"><p><strong>Due Date:</strong> ${loan.repaymentDetails.dueDate || 'N/A'}</p></div>`;
                        }
                        detailsHtml += `</div>`;
                    }
                    openModal(`Loan Details - ${loanId.substring(0,8)}...`, detailsHtml);
                } else { showToast("Loan request not found.", 3000, 'error'); }
            } catch (error) { showToast(`Error fetching loan details: ${error.message}`, 3000, 'error'); console.error(error); }
            showLoading(false);
        };
        window.processLoanAction = async (loanId, action) => {
            const loanDocRefFirestore = doc(db, "loanApplications", loanId);
            const loanNodeRefRtdb = ref(rtdb, `loanApplications/${loanId}`);
            let loanData;
            try {
                const loanDocSnap = await getDoc(loanDocRefFirestore);
                if (!loanDocSnap.exists()) { showToast("Loan not found.", 3000, 'error'); return; }
                loanData = loanDocSnap.data();
            } catch(e) { showToast("Error fetching loan data for action.", 3000, 'error'); return;}
            
            let modalContentHtml = '';
            if (action === 'Approved') {
                modalContentHtml = `<h4>Approve Loan: ${loanId.substring(0,8)}...</h4> <p>Applicant: ${loanData.userName || loanData.userEmail}</p> <form id="approveLoanForm" class="admin-form">`;
                if (loanData.loanType === 'personal') {
                    modalContentHtml += `<div class="form-group"><label for="approvedMonthlyEMI">Monthly EMI (₹)</label><input type="number" id="approvedMonthlyEMI" value="${parseFloat(loanData.calculatedEmiOrTotal?.replace(/[^0-9.]/g, "") || 0)}" required></div> <div class="form-group"><label for="approvedTenureMonths">Tenure (Months)</label><input type="number" id="approvedTenureMonths" value="${parseInt(loanData.tenure) || ''}" required></div> <div class="form-group"><label for="emiStartDate">EMI Start Date</label><input type="date" id="emiStartDate" required></div>`;
                } else { /* Credit Limit */
                    modalContentHtml += `<div class="form-group"><label for="approvedTotalRepayment">Total Repayment (₹)</label><input type="number" id="approvedTotalRepayment" value="${parseFloat(loanData.calculatedEmiOrTotal?.replace(/[^0-9.]/g, "") || 0)}" required></div> <div class="form-group"><label for="repaymentDueDate">Repayment Due Date</label><input type="date" id="repaymentDueDate" required></div>`;
                }
                modalContentHtml += `<button type="submit" class="btn btn-success">Confirm Approval</button></form>`;
            } else if (action === 'Rejected') {
                modalContentHtml = `<h4>Reject Loan: ${loanId.substring(0,8)}...</h4> <p>Applicant: ${loanData.userName || loanData.userEmail}</p> <form id="rejectLoanForm" class="admin-form"><div class="form-group"><label for="rejectionReason">Reason for Rejection</label><textarea id="rejectionReason" required></textarea></div><button type="submit" class="btn btn-danger">Confirm Rejection</button></form>`;
            }
            openModal(`Confirm ${action} Loan`, modalContentHtml);

            if (action === 'Approved') {
                document.getElementById('approveLoanForm')?.addEventListener('submit', async (e) => {
                    e.preventDefault(); showLoading(true);
                    const updatesFirestore = { status: 'Approved', adminReviewed: true, reviewedAt: Timestamp.now(), approvedAt: Timestamp.now() };
                    const updatesRtdb = { status: 'Approved', adminReviewed: true, reviewedAt: serverTimestamp(), approvedAt: serverTimestamp() };

                    if (loanData.loanType === 'personal') {
                        const monthlyEMI = parseFloat(document.getElementById('approvedMonthlyEMI').value);
                        const tenureMonths = parseInt(document.getElementById('approvedTenureMonths').value);
                        const startDate = document.getElementById('emiStartDate').value;
                        // Basic next due date - for robust, use a date library
                        let nextDueDate = new Date(startDate); nextDueDate.setMonth(nextDueDate.getMonth() + 1);

                        updatesFirestore.emiSchedule = { monthlyEMI: `₹${monthlyEMI.toLocaleString('en-IN')}`, tenureMonths, startDate, nextDueDate: nextDueDate.toISOString().split('T')[0] };
                        updatesRtdb.emiSchedule = updatesFirestore.emiSchedule; 
                    } else { // Credit Limit
                        const totalRepayment = parseFloat(document.getElementById('approvedTotalRepayment').value);
                        const dueDate = document.getElementById('repaymentDueDate').value;
                        updatesFirestore.repaymentDetails = { totalAmount: `₹${totalRepayment.toLocaleString('en-IN')}`, dueDate };
                        updatesRtdb.repaymentDetails = updatesFirestore.repaymentDetails;
                    }
                    try {
                        await updateDoc(loanDocRefFirestore, updatesFirestore);
                        await rtdbUpdate(loanNodeRefRtdb, updatesRtdb);
                        showToast('Loan approved!', 2000, 'success'); closeModal(); loadLoanRequests(); if(currentOpenSection === 'activeLoansSection') loadActiveLoans();
                    } catch (err) { showToast(`Error approving: ${err.message}`, 3000, 'error'); console.error(err); }
                    showLoading(false);
                });
            } else if (action === 'Rejected') {
                document.getElementById('rejectLoanForm')?.addEventListener('submit', async (e) => {
                    e.preventDefault(); showLoading(true);
                    const reason = document.getElementById('rejectionReason').value;
                    const updatesFirestore = { status: 'Rejected', rejectionReason: reason, adminReviewed: true, reviewedAt: Timestamp.now() };
                    const updatesRtdb = { status: 'Rejected', rejectionReason: reason, adminReviewed: true, reviewedAt: serverTimestamp() };
                    try {
                        await updateDoc(loanDocRefFirestore, updatesFirestore);
                        await rtdbUpdate(loanNodeRefRtdb, updatesRtdb);
                        showToast('Loan rejected.', 2000); closeModal(); loadLoanRequests();
                    } catch (err) { showToast(`Error rejecting: ${err.message}`, 3000, 'error'); console.error(err); }
                    showLoading(false);
                });
            }
        };
        
        // --- Active Loans ---
        async function loadActiveLoans() {
            showLoading();
            if(!activeLoansTableBody) { showLoading(false); return; }
            activeLoansTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">Loading active loans...</td></tr>';
            const q = query(collection(db, "loanApplications"), where("status", "==", "Approved"), orderBy("approvedAt", "desc"));
            try {
                const querySnapshot = await getDocs(q);
                let loans = []; querySnapshot.forEach(doc => loans.push({ id: doc.id, ...doc.data() }));
                const searchTerm = activeLoanSearchInput ? activeLoanSearchInput.value.toLowerCase() : '';
                if (searchTerm) { loans = loans.filter(l => l.userName?.toLowerCase().includes(searchTerm) || l.userEmail?.toLowerCase().includes(searchTerm) || l.id.toLowerCase().includes(searchTerm)); }
                renderActiveLoansTable(loans);
            } catch (error) { 
                console.error("Active loans error:", error); 
                if(activeLoansTableBody) activeLoansTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">Error loading active loans.</td></tr>';
                showToast("Error loading active loans.", 3000, "error");
            }
            showLoading(false);
        }
        activeLoanSearchInput?.addEventListener('input', loadActiveLoans);
        function renderActiveLoansTable(loans) {
            if(!activeLoansTableBody) return; activeLoansTableBody.innerHTML = '';
            if (loans.length === 0) { activeLoansTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">No active loans found.</td></tr>'; return; }
            loans.forEach(loan => {
                const row = activeLoansTableBody.insertRow();
                let repaymentInfo = 'N/A', dueDateInfo = 'N/A', overallStatus = 'On-track'; // Placeholder for overall status
                if (loan.loanType === 'personal' && loan.emiSchedule) {
                    repaymentInfo = loan.emiSchedule.monthlyEMI || 'N/A';
                    dueDateInfo = loan.emiSchedule.nextDueDate || loan.emiSchedule.startDate || 'N/A';
                } else if (loan.loanType === 'credit' && loan.repaymentDetails) {
                    repaymentInfo = loan.repaymentDetails.totalAmount || 'N/A';
                    dueDateInfo = loan.repaymentDetails.dueDate || 'N/A';
                }
                // Basic overdue check (simplified)
                if(dueDateInfo !== 'N/A' && new Date(dueDateInfo) < new Date()) overallStatus = 'Overdue';

                row.innerHTML = `<td>${loan.id.substring(0,8)}..</td><td>${loan.userName || loan.userEmail}</td><td>${loan.loanType}</td><td>₹${loan.loanAmount?.toLocaleString('en-IN')}</td><td>${repaymentInfo}</td><td>${dueDateInfo}</td><td><span class="status-pill ${overallStatus.toLowerCase()}">${overallStatus}</span></td>`;
                row.style.cursor = 'pointer';
                row.onclick = () => viewLoanRequestDetails(loan.id); // Reuse viewLoanRequestDetails
            });
        }

        // --- Blocked Users ---
        async function loadBlockedUsers() {
            showLoading();
            if(!blockedUsersTableBody) { showLoading(false); return; }
            blockedUsersTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Loading blocked users...</td></tr>';
            const q = query(collection(db, "users"), where("isBlocked", "==", true), orderBy("fullName", "asc"));
            try {
                const querySnapshot = await getDocs(q);
                let users = []; querySnapshot.forEach(doc => users.push({ id: doc.id, ...doc.data() }));
                const searchTerm = blockedUserSearchInput ? blockedUserSearchInput.value.toLowerCase() : '';
                if (searchTerm) { users = users.filter(u => u.fullName?.toLowerCase().includes(searchTerm) || u.email?.toLowerCase().includes(searchTerm) || u.id.toLowerCase().includes(searchTerm)); }
                renderBlockedUsersTable(users);
            } catch (error) { 
                console.error("Blocked users error:", error); 
                if(blockedUsersTableBody) blockedUsersTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Error loading blocked users.</td></tr>';
                showToast("Error loading blocked users.", 3000, "error");
            }
            showLoading(false);
        }
        blockedUserSearchInput?.addEventListener('input', loadBlockedUsers);
        function renderBlockedUsersTable(users) {
            if(!blockedUsersTableBody) return; blockedUsersTableBody.innerHTML = '';
            if (users.length === 0) { blockedUsersTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No blocked users found.</td></tr>'; return; }
            users.forEach(user => {
                const row = blockedUsersTableBody.insertRow();
                row.innerHTML = `<td>${user.id.substring(0,8)}..</td><td>${user.fullName||'N/A'}</td><td>${user.email}</td><td>${user.blockReason || 'N/A'}</td>
                <td class="action-buttons-group"><button class="action-btn btn-info" onclick="viewUserDetails('${user.id}')">Details</button><button class="action-btn btn-success" onclick="toggleUserBlockStatus('${user.id}', true)">Unblock</button></td>`;
            });
        }

        // --- Payment Methods (RTDB Realtime) ---
        function loadPaymentMethodsWithListener() {
            if (listeners.paymentMethods) listeners.paymentMethods();
            showLoading();
            const paymentRef = ref(rtdb, 'appConfig/paymentMethods');
            listeners.paymentMethods = onValue(paymentRef, (snapshot) => {
                const data = snapshot.val();
                if(upiIdInput) upiIdInput.value = data?.upiId || '';
                if(bankDetailsInput) bankDetailsInput.value = data?.bankDetails || '';
                if(previewUpiId) previewUpiId.textContent = data?.upiId || 'Not set';
                if(previewBankDetails) previewBankDetails.textContent = data?.bankDetails || 'Not set';
                showLoading(false);
            }, (error) => { console.error("Payment methods listener error:", error); showToast("Error loading payment methods.", 3000, "error"); showLoading(false);});
        }
        upiIdInput?.addEventListener('input', () => { if(previewUpiId && upiIdInput) previewUpiId.textContent = upiIdInput.value || 'Not set'; });
        bankDetailsInput?.addEventListener('input', () => { if(previewBankDetails && bankDetailsInput) previewBankDetails.textContent = bankDetailsInput.value || 'Not set'; });
        paymentMethodsForm?.addEventListener('submit', async (e) => {
            e.preventDefault(); showLoading();
            const paymentMethodsRefRTDB = ref(rtdb, 'appConfig/paymentMethods');
            const newUpiId = upiIdInput?.value.trim() || '';
            const newBankDetails = bankDetailsInput?.value.trim() || '';
            if (!newUpiId || !newBankDetails) { showToast("Both UPI ID and Bank Details are required.", 3000, 'error'); showLoading(false); return; }
            try {
                await set(paymentMethodsRefRTDB, { upiId: newUpiId, bankDetails: newBankDetails });
                showToast("Payment methods updated!", 2000, 'success');
            } catch (error) { console.error("Error saving payment methods:", error); showToast("Failed to save payment methods.", 3000, 'error'); }
            showLoading(false);
        });
        
        // --- Support Requests (RTDB Realtime) ---
        let supportRequestsData = [];
        function loadSupportRequestsWithListener() {
            if (listeners.supportRequests) listeners.supportRequests();
            showLoading();
            if(!supportRequestsTableBody) { showLoading(false); return; }
            supportRequestsTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Loading support requests...</td></tr>';
            const supportRequestsRefRTDB = rtdbQuery(ref(rtdb, 'supportRequests'), orderByChild('timestamp'));
            
            listeners.supportRequests = onValue(supportRequestsRefRTDB, (snapshot) => {
                supportRequestsData = [];
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => { supportRequestsData.push({ id: childSnapshot.key, ...childSnapshot.val() }); });
                    supportRequestsData.reverse(); 
                }
                filterAndRenderSupportRequests();
                showLoading(false);
            }, (error) => { 
                console.error("Support requests listener error:", error); 
                if(supportRequestsTableBody) supportRequestsTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Error loading requests.</td></tr>';
                showToast("Error loading support requests.", 3000, "error"); showLoading(false); 
            });
        }
        function filterAndRenderSupportRequests() {
            if(!supportRequestsTableBody) return;
            let filteredData = [...supportRequestsData];
            const searchTerm = supportSearchInput ? supportSearchInput.value.toLowerCase() : '';
            const showUnreadOnly = unreadByAdminFilter ? unreadByAdminFilter.checked : false;
            if (searchTerm) { filteredData = filteredData.filter(req => req.userName?.toLowerCase().includes(searchTerm) || req.userId?.toLowerCase().includes(searchTerm) || req.id?.toLowerCase().includes(searchTerm)); }
            if (showUnreadOnly) { filteredData = filteredData.filter(req => req.unreadByAdmin === true); }
            renderSupportRequestsTable(filteredData);
        }
        supportSearchInput?.addEventListener('input', filterAndRenderSupportRequests);
        unreadByAdminFilter?.addEventListener('change', filterAndRenderSupportRequests);

        function renderSupportRequestsTable(requests) {
            if(!supportRequestsTableBody) return; supportRequestsTableBody.innerHTML = '';
            if (requests.length === 0) { supportRequestsTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No support requests match criteria.</td></tr>'; return; }
            requests.forEach(req => {
                const row = supportRequestsTableBody.insertRow();
                const lastMessageSnippet = req.lastMessage ? (req.lastMessage.length > 40 ? req.lastMessage.substring(0, 40) + '...' : req.lastMessage) : 'N/A';
                const timestamp = req.timestamp ? new Date(req.timestamp).toLocaleString() : 'N/A';
                let statusText = req.unreadByAdmin ? '<span class="status-pill new-message">New Message</span>' : (req.lastSender === 'admin' ? 'Replied' : 'Viewed');
                if (req.isClosed) statusText = '<span class="status-pill blocked">Closed</span>';


                row.innerHTML = `<td>${req.userName || req.userId}</td><td>${lastMessageSnippet}</td><td>${timestamp}</td><td>${statusText}</td>
                <td class="action-buttons-group"><button class="action-btn btn-info" onclick="openAdminSupportChat('${req.userId}', '${req.userName || req.userId}')">Open Chat</button></td>`;
            });
        }
        window.openAdminSupportChat = (userId, userName) => {
            listeners.currentChatUserId = userId; // Use a different variable if `currentChatUserId` causes issues with global scope for listeners
            const chatHtml = `<div id="adminSupportChatView"><div id="adminChatMessagesArea">Loading messages...</div><form id="adminChatForm"><input type="text" id="adminChatMessageInput" placeholder="Type your reply..." autocomplete="off"><button type="submit" class="btn btn-sm">Send</button></form></div>`;
            openModal(`Chat with ${userName}`, chatHtml);
            loadAdminChatMessages(userId);

            const supportRequestRef = ref(rtdb, `supportRequests/${userId}`);
            get(supportRequestRef).then(snapshot => {
                if (snapshot.exists() && snapshot.val().unreadByAdmin) { rtdbUpdate(supportRequestRef, {unreadByAdmin: false}); }
            });

            document.getElementById('adminChatForm')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const messageInput = document.getElementById('adminChatMessageInput');
                const messageText = messageInput.value.trim();
                if (!messageText || !listeners.currentChatUserId || !currentAdminUser) return;

                const chatPath = `supportChats/${listeners.currentChatUserId}`;
                const newMessageRef = push(ref(rtdb, chatPath));
                try {
                    await set(newMessageRef, { sender: 'admin', senderName: 'Admin Support', text: messageText, timestamp: serverTimestamp() });
                    const srRef = ref(rtdb, `supportRequests/${listeners.currentChatUserId}`);
                    await rtdbUpdate(srRef, { lastMessage: messageText, timestamp: serverTimestamp(), lastSender: 'admin', unreadByAdmin: false, unreadByUser: true });
                    messageInput.value = '';
                } catch (error) { console.error("Error sending admin message:", error); showToast("Could not send message.", 2000, 'error'); }
            });
        };
        function loadAdminChatMessages(userId) {
            const chatMessagesArea = document.getElementById('adminChatMessagesArea');
            if (!chatMessagesArea) return;
            chatMessagesArea.innerHTML = '<p style="text-align:center; color:var(--text-light);">Loading messages...</p>';
            const chatPath = `supportChats/${userId}`;
            const messagesRef = rtdbQuery(ref(rtdb, chatPath), orderByChild('timestamp')); // Order messages

            if (listeners.currentChat) { try {listeners.currentChat();} catch(e){console.warn(e)} } // Unsubscribe previous

            listeners.currentChat = onValue(messagesRef, (snapshot) => {
                chatMessagesArea.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const message = childSnapshot.val();
                        displayAdminChatMessage(message.sender, message.text, message.timestamp, chatMessagesArea);
                    });
                } else { chatMessagesArea.innerHTML = '<p style="text-align:center; color:var(--text-light);">No messages yet.</p>'; }
                chatMessagesArea.scrollTop = chatMessagesArea.scrollHeight;
            }, (error) => { console.error(`Error loading chat for ${userId}:`, error); chatMessagesArea.innerHTML = '<p style="color:var(--error-color);">Could not load messages.</p>'; });
        }
        function displayAdminChatMessage(sender, text, timestamp, area) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message');
            messageDiv.classList.add(sender === 'admin' ? 'admin' : 'user'); 
            const textNode = document.createElement('span'); textNode.textContent = text; messageDiv.appendChild(textNode);
            if (timestamp) {
                const timeSpan = document.createElement('span'); timeSpan.classList.add('timestamp');
                timeSpan.textContent = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                messageDiv.appendChild(timeSpan);
            }
            area.appendChild(messageDiv);
        }
        
    </script>
</body>
</html>