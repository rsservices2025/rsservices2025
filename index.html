<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Quids - Admin Panel</title>
    <style>
        :root {
            --primary-color: #5F259F;
            --primary-color-rgb: 95, 37, 159;
            --primary-light: #7E57C2; 
            --accent-color: #FFD700; 
            --content-bg: #F4F6FC;
            --card-bg: #FFFFFF;
            --text-color: #333D49;
            --text-light: #6C757D;
            --text-on-primary: #FFFFFF;
            --success-color: #28A745;
            --error-color: #DC3545;
            --info-color: #17A2B8;
            --warn-color: #FFC107; /* Corrected from previous */
            --border-color: #E0E0E0;
            --input-bg: #F9FAFB; /* Changed from #FFFFFF for better contrast on forms */
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
            --font-family: 'Roboto', 'Segoe UI', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            background-color: var(--content-bg);
            color: var(--text-color);
            font-size: 15px;
            line-height: 1.5;
        }

        /* Login Screen */
        .admin-login-container { display: flex; justify-content: center; align-items: center; width: 100%; min-height: 100vh; background: var(--primary-color); }
        .login-box { background-color: var(--card-bg); padding: 30px 35px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .login-box h1 { color: var(--primary-color); font-size: 1.8em; margin-bottom: 25px; font-weight: 700; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; font-size: 0.9em; font-weight: 500; color: var(--text-light); margin-bottom: 8px; }
        .form-group input { width: 100%; padding: 12px 15px; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; color: var(--text-color); }
        .form-group input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.2); }
        .btn { display: inline-block; padding: 12px 25px; background: var(--primary-color); color: var(--text-on-primary); border: none; border-radius: 8px; font-size: 1em; font-weight: 500; cursor: pointer; text-align: center; transition: background-color 0.2s ease, transform 0.1s ease; }
        .btn:hover { background-color: var(--primary-color-dark); }
        .btn:active { transform: scale(0.98); }
        #adminLoginError { color: var(--error-color); font-size: 0.9em; margin-top: 15px; display: none; }

        /* Admin Dashboard Layout */
        .admin-dashboard-layout { width: 100%; min-height: 100vh; display:flex; flex-direction:column; }
        .admin-top-header { background-color: var(--primary-color); padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        .admin-top-header h1 { font-size: 1.4em; color: var(--text-on-primary); margin: 0; font-weight: 500; }
        #adminLogoutBtn { background-color: rgba(255,255,255,0.2); color: var(--text-on-primary); padding: 7px 15px; font-size: 0.9em; border-radius: 6px; }
        #adminLogoutBtn:hover { background-color: rgba(255,255,255,0.3); }

        .admin-nav-tabs { display: flex; background-color: var(--primary-color-dark); box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow-x: auto; }
        .admin-nav-tab { padding: 12px 18px; color: rgba(255,255,255,0.75); cursor: pointer; font-weight: 500; border-bottom: 3px solid transparent; transition: color 0.2s, border-bottom-color 0.2s, background-color 0.2s; white-space: nowrap; font-size: 0.9em; }
        .admin-nav-tab:hover { background-color: var(--primary-light); color: var(--text-on-primary); }
        .admin-nav-tab.active { color: var(--text-on-primary); border-bottom-color: var(--accent-color); background-color: var(--primary-light); font-weight: 600; }

        .admin-main-content { padding: 25px; flex-grow: 1; }
        .admin-section { display: none; animation: fadeInContent 0.3s ease-out; }
        .admin-section.active { display: block; }
        @keyframes fadeInContent { from{opacity:0; transform: translateY(5px);} to{opacity:1; transform:translateY(0);} }
        .section-title-header { font-size: 1.7em; color: var(--primary-color); margin-bottom: 20px; font-weight: 600; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        
        .filters-bar { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; padding: 15px; background-color:var(--card-bg); border-radius:8px; box-shadow: var(--shadow); }
        .filters-bar input[type="text"], .filters-bar select { padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9em; flex-grow:1; background-color: var(--input-bg); }
        .filters-bar label { display: flex; align-items: center; font-size: 0.9em; } .filters-bar input[type="checkbox"] { margin-right: 5px; accent-color: var(--primary-color); }

        .table-container { background-color: var(--card-bg); border-radius: 8px; box-shadow: var(--shadow); overflow-x:auto; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .data-table th, .data-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle;}
        .data-table thead th { background-color: #F1F3F5; color: var(--text-light); font-weight: 500; font-size: 0.85em; text-transform: uppercase; }
        .data-table tbody tr:hover { background-color: #f8f9fa; }
        .action-btn { padding: 5px 10px; font-size:0.8em; margin-right:5px; border-radius:5px; cursor:pointer; border:none; color:white; }
        .btn-info { background-color: var(--info-color); } .btn-info:hover { background-color: #117a8b;}
        .btn-success { background-color: var(--success-color); } .btn-success:hover { background-color: #1e7e34;}
        .btn-danger { background-color: var(--error-color); } .btn-danger:hover { background-color: #bd2130;}
        .btn-warn { background-color: var(--warn-color); color:var(--text-color); } .btn-warn:hover { background-color: #e0a800;}

        .status-pill { padding: 3px 8px; border-radius: 15px; font-size: 0.8em; font-weight: 500; display: inline-block; text-align: center; min-width: 80px; }
        .status-pill.active, .status-pill.approved { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;}
        .status-pill.blocked, .status-pill.rejected { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
        .status-pill.under-process { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;}
        .status-pill.new-message { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;}

        .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--card-bg); margin: auto; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 100%; max-width: 700px; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .modal-header h3 { margin: 0; color: var(--primary-color); font-size: 1.3em; font-weight: 600; }
        .modal-close-btn { font-size: 1.8em; font-weight: bold; color: var(--text-light); background: none; border: none; cursor: pointer; line-height: 1; padding: 5px; }
        .modal-close-btn:hover { color: var(--text-color); }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px 20px; font-size:0.95em; }
        .detail-item p { margin-bottom: 7px; } .detail-item strong { font-weight: 500; color: var(--text-light); margin-right:5px; }
        #adminSupportChatView { display: flex; flex-direction: column; height: 60vh; }
        #adminChatMessagesArea { flex-grow: 1; overflow-y: auto; padding: 15px; background-color: var(--content-bg); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px; }
        #adminSupportChatView .chat-message.admin { background-color: var(--primary-color); color: var(--text-on-primary); }
        #adminSupportChatView .chat-message.user { background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); }
        #adminChatForm { display: flex; align-items: center; }
        #adminChatMessageInput { flex-grow: 1; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 20px; margin-right: 10px; font-size: 0.95em; }
        #adminChatForm button { padding: 10px 15px; border-radius: 20px; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; display: none; backdrop-filter: blur(2px); }
        .loading-spinner { border: 5px solid rgba(var(--primary-color-rgb),0.2); border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast-notification { position: fixed; top: 20px; right: 20px; background-color: var(--text-color); color: var(--text-on-primary); padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); z-index: 10000; font-size: 0.9em; opacity: 0; transform: translateY(-20px) ; transition: opacity 0.3s ease, transform 0.3s ease; }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .toast-notification.success { background-color: var(--success-color); } .toast-notification.error { background-color: var(--error-color); } .toast-notification.info { background-color: var(--info-color); }
        
        .admin-form { padding-top: 10px; }
        .admin-form .form-group label {color: var(--text-light); font-weight:400;}
        .admin-form textarea { min-height: 80px; }

        @media (max-width: 768px) {
            .admin-nav-tabs { font-size: 0.85em; }
            .admin-nav-tab { padding: 12px 10px; }
            .admin-main-content { padding: 15px; }
            .section-title-header { font-size: 1.5em; }
            .filters-bar { flex-direction: column; gap: 10px; }
            .filters-bar input[type="text"], .filters-bar select { width:100%;}
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="adminLoginScreen" class="admin-login-container screen active">
        <div class="login-box">
            <h1>Admin Login</h1>
            <form id="adminLoginForm">
                <div class="form-group"><label for="adminLoginEmail">Email Address</label><input type="email" id="adminLoginEmail" required autocomplete="username"></div>
                <div class="form-group"><label for="adminLoginPassword">Password</label><input type="password" id="adminLoginPassword" required autocomplete="current-password"></div>
                <button type="submit" class="btn" style="width:100%;">Login</button>
                <p id="adminLoginError"></p>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard Layout -->
    <div id="adminDashboardLayout" class="admin-dashboard-layout screen">
        <header class="admin-top-header">
            <h1>Quick Quids Admin</h1>
            <button id="adminLogoutBtn" class="btn btn-sm">Logout</button>
        </header>
        <nav class="admin-nav-tabs" id="adminNavTabs">
            <span class="admin-nav-tab active" data-section="usersSection">Users</span>
            <span class="admin-nav-tab" data-section="loanRequestsSection">Loan Requests</span>
            <span class="admin-nav-tab" data-section="activeLoansSection">Active Loans</span>
            <span class="admin-nav-tab" data-section="blockedUsersSection">Blocked Users</span>
            <span class="admin-nav-tab" data-section="paymentMethodsSection">Payment Methods</span>
            <span class="admin-nav-tab" data-section="supportRequestsSection">Support Requests</span>
        </nav>
        <main class="admin-main-content">
            <section id="usersSection" class="admin-section active">
                <h2 class="section-title-header">User Management</h2>
                <div class="filters-bar"><input type="text" id="userSearchInput" placeholder="Search by Name, Email, UID..."></div>
                <div class="table-container"><table class="data-table" id="usersTable"><thead><tr><th>UID</th><th>Full Name</th><th>Email</th><th>Mobile</th><th>Status</th><th>Actions</th></tr></thead><tbody><tr><td colspan="6" style="text-align:center; padding:20px;">Loading users...</td></tr></tbody></table></div>
            </section>
            <section id="loanRequestsSection" class="admin-section">
                <h2 class="section-title-header">Loan Application Requests</h2>
                <div class="filters-bar"><input type="text" id="loanRequestSearchInput" placeholder="Search by Applicant, Email, Loan ID..."><select id="loanStatusFilter"><option value="all">All Statuses</option><option value="Under Process">Under Process</option><option value="Approved">Approved</option><option value="Rejected">Rejected</option></select><label><input type="checkbox" id="onlyPendingReviewFilter"> Only Pending Review</label></div>
                <div class="table-container"><table class="data-table" id="loanRequestsTable"><thead><tr><th>Loan ID</th><th>Applicant</th><th>Type</th><th>Amount (₹)</th><th>Fee TxID</th><th>Applied</th><th>Status</th><th>Actions</th></tr></thead><tbody><tr><td colspan="8" style="text-align:center; padding:20px;">Loading requests...</td></tr></tbody></table></div>
            </section>
            <section id="activeLoansSection" class="admin-section">
                <h2 class="section-title-header">Active Loans Monitoring</h2>
                <div class="filters-bar"><input type="text" id="activeLoanSearchInput" placeholder="Search by Applicant, Loan ID..."></div>
                <div class="table-container"><table class="data-table" id="activeLoansTable"><thead><tr><th>Loan ID</th><th>Applicant</th><th>Type</th><th>Approved (₹)</th><th>EMI/Total (₹)</th><th>Next Due</th><th>Overall Status</th></tr></thead><tbody><tr><td colspan="7" style="text-align:center; padding:20px;">Loading active loans...</td></tr></tbody></table></div>
            </section>
            <section id="blockedUsersSection" class="admin-section">
                <h2 class="section-title-header">Blocked Users</h2>
                <div class="filters-bar"><input type="text" id="blockedUserSearchInput" placeholder="Search by Name, Email, UID..."></div>
                <div class="table-container"><table class="data-table" id="blockedUsersTable"><thead><tr><th>UID</th><th>Full Name</th><th>Email</th><th>Reason</th><th>Actions</th></tr></thead><tbody><tr><td colspan="5" style="text-align:center; padding:20px;">Loading blocked users...</td></tr></tbody></table></div>
            </section>
            <section id="paymentMethodsSection" class="admin-section">
                <h2 class="section-title-header">Payment Method Configuration</h2>
                <form id="paymentMethodsForm" class="admin-form" style="max-width:600px; background:var(--card-bg); padding:20px; border-radius:8px; box-shadow:var(--shadow);">
                    <p style="color:var(--text-light); font-size:0.9em; margin-bottom:15px;">These details appear on the user panel for processing fee payment.</p>
                    <div class="form-group"><label for="upiIdInput">UPI ID</label><input type="text" id="upiIdInput" required></div>
                    <div class="form-group"><label for="bankDetailsInput">Bank Account Details (Acct Name, Number, IFSC)</label><textarea id="bankDetailsInput" rows="3" required></textarea></div>
                    <button type="submit" class="btn">Save Payment Methods</button>
                    <div id="paymentMethodsPreview" style="margin-top:20px; padding:15px; background-color:#f8f9fa; border:1px dashed var(--border-color); border-radius:8px;">
                        <h4 style="margin-bottom:10px; font-weight:500;">Preview (User View):</h4>
                        <p><strong>UPI:</strong> <span id="previewUpiId">Not set</span></p>
                        <p><strong>Bank:</strong> <span id="previewBankDetails">Not set</span></p>
                    </div>
                </form>
            </section>
            <section id="supportRequestsSection" class="admin-section">
                <h2 class="section-title-header">Customer Support Requests</h2>
                <div class="filters-bar"><input type="text" id="supportSearchInput" placeholder="Search by User Name, User ID..."><label><input type="checkbox" id="unreadByAdminFilter"> Only Unread by Admin</label></div>
                <div class="table-container"><table class="data-table" id="supportRequestsTable"><thead><tr><th>User Name</th><th>Last Message</th><th>Timestamp</th><th>Status</th><th>Actions</th></tr></thead><tbody><tr><td colspan="5" style="text-align:center; padding:20px;">Loading support requests...</td></tr></tbody></table></div>
            </section>
        </main>
    </div>

    <div id="adminModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 id="adminModalTitle"></h3><button class="modal-close-btn" id="adminModalCloseBtn">&times;</button></div><div id="adminModalBody"></div></div></div>
    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>
    <div class="toast-notification" id="toastNotification"></div>

    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut as firebaseSignOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, query, where, orderBy, Timestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";
        import { getDatabase, ref, get, set, push, onValue, serverTimestamp, query as rtdbQuery, orderByChild as rtdbOrderByChild, update as rtdbUpdate } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5lWYt4OTJLwWCrcBFs2YuFjMSGBfmWFs", authDomain: "quickquids1.firebaseapp.com",
            databaseURL: "https://quickquids1-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "quickquids1",
            storageBucket: "quickquids1.firebasestorage.app", messagingSenderId: "536263689144",
            appId: "1:536263689144:web:276640940106438cf8454d", measurementId: "G-7SEB49V2LL"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        // DOM Elements
        const adminLoginScreen = document.getElementById('adminLoginScreen');
        const adminDashboardLayout = document.getElementById('adminDashboardLayout');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const adminLoginEmailInput = document.getElementById('adminLoginEmail');
        const adminLoginPasswordInput = document.getElementById('adminLoginPassword');
        const adminLoginError = document.getElementById('adminLoginError');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const adminNavTabs = document.querySelectorAll('.admin-nav-tab');
        const adminSections = document.querySelectorAll('.admin-section');
        const usersTableBody = document.querySelector('#usersTable tbody');
        const userSearchInput = document.getElementById('userSearchInput');
        const loanRequestsTableBody = document.querySelector('#loanRequestsTable tbody');
        const loanRequestSearchInput = document.getElementById('loanRequestSearchInput');
        const loanStatusFilter = document.getElementById('loanStatusFilter');
        const onlyPendingReviewFilter = document.getElementById('onlyPendingReviewFilter');
        const activeLoansTableBody = document.querySelector('#activeLoansTable tbody');
        const activeLoanSearchInput = document.getElementById('activeLoanSearchInput');
        const blockedUsersTableBody = document.querySelector('#blockedUsersTable tbody');
        const blockedUserSearchInput = document.getElementById('blockedUserSearchInput');
        const paymentMethodsForm = document.getElementById('paymentMethodsForm');
        const upiIdInput = document.getElementById('upiIdInput');
        const bankDetailsInput = document.getElementById('bankDetailsInput');
        const previewUpiId = document.getElementById('previewUpiId');
        const previewBankDetails = document.getElementById('previewBankDetails');
        const supportRequestsTableBody = document.querySelector('#supportRequestsTable tbody');
        const supportSearchInput = document.getElementById('supportSearchInput');
        const unreadByAdminFilter = document.getElementById('unreadByAdminFilter');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const toastNotification = document.getElementById('toastNotification');
        const adminModal = document.getElementById('adminModal');
        const adminModalTitle = document.getElementById('adminModalTitle');
        const adminModalBody = document.getElementById('adminModalBody');
        const adminModalCloseBtn = document.getElementById('adminModalCloseBtn');

        let currentAdminUser = null;
        let currentOpenSection = 'usersSection'; 
        let listeners = { users: null, paymentMethods: null, supportRequests: null, currentChat: null };

        // --- Utility Functions ---
        function showLoading(show = true) { loadingOverlay.style.display = show ? 'flex' : 'none';}
        function showToast(message, duration = 3000, type = 'info') {
            toastNotification.textContent = message; toastNotification.className = 'toast-notification'; 
            if (type) toastNotification.classList.add(type); // 'success', 'error', or 'info'
            toastNotification.classList.add('show'); setTimeout(() => toastNotification.classList.remove('show'), duration);
        }
        function openModal(title, contentHtml) { 
            if(adminModalTitle) adminModalTitle.textContent = title; 
            if(adminModalBody) adminModalBody.innerHTML = contentHtml; 
            if(adminModal) adminModal.classList.add('active'); 
        }
        function closeModal() { 
            if(adminModal) adminModal.classList.remove('active'); 
            if(adminModalBody) adminModalBody.innerHTML = ''; 
            if(listeners.currentChat) { try { listeners.currentChat(); listeners.currentChat=null; } catch(e){console.warn("Chat listener unsub error",e)} }
        }
        adminModalCloseBtn?.addEventListener('click', closeModal);
        adminModal?.addEventListener('click', (e) => { if (e.target === adminModal) closeModal(); });
        
        function cleanupListeners() {
            Object.keys(listeners).forEach(key => {
                if (listeners[key]) { try { listeners[key](); listeners[key] = null; } catch(e){ console.warn(`Error unsubscribing ${key}:`, e); }}
            });
        }

        function switchSection(sectionId) {
            cleanupListeners(); 
            currentOpenSection = sectionId;
            adminSections.forEach(s => s.classList.remove('active'));
            const targetSection = document.getElementById(sectionId);
            if(targetSection) targetSection.classList.add('active'); else { console.error("Target section not found:", sectionId); return; }

            adminNavTabs.forEach(tab => tab.classList.remove('active'));
            const activeTab = document.querySelector(`.admin-nav-tab[data-section="${sectionId}"]`);
            if(activeTab) activeTab.classList.add('active');
            
            const sectionHeader = targetSection.querySelector('h2.section-title-header');
            // Titles are now in each section's HTML, no central title element.

            if (sectionId === 'usersSection') loadUsersWithListener();
            else if (sectionId === 'loanRequestsSection') loadLoanRequests();
            else if (sectionId === 'activeLoansSection') loadActiveLoans();
            else if (sectionId === 'blockedUsersSection') loadBlockedUsers();
            else if (sectionId === 'paymentMethodsSection') loadPaymentMethodsWithListener();
            else if (sectionId === 'supportRequestsSection') loadSupportRequestsWithListener();
        }

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            showLoading();
            if (user) {
                try {
                    const idTokenResult = await user.getIdTokenResult(true); 
                    if (idTokenResult.claims.admin === true) {
                        currentAdminUser = user;
                        adminLoginScreen.classList.remove('active'); adminDashboardLayout.classList.add('active');
                        switchSection('usersSection'); 
                        showToast(`Welcome Admin!`, 2000, 'success');
                    } else {
                        await firebaseSignOut(auth); 
                        if(adminLoginError) {adminLoginError.textContent = "Access Denied. Not an authorized admin."; adminLoginError.style.display = 'block';}
                        adminDashboardLayout.classList.remove('active'); adminLoginScreen.classList.add('active'); // Ensure login is shown
                    }
                } catch (error) {
                     console.error("Admin claim check error:", error); 
                     await firebaseSignOut(auth); 
                     if(adminLoginError){adminLoginError.textContent = "Error verifying admin status. Please login again."; adminLoginError.style.display = 'block';}
                     adminDashboardLayout.classList.remove('active'); adminLoginScreen.classList.add('active'); // Ensure login is shown
                }
            } else {
                currentAdminUser = null; cleanupListeners();
                adminDashboardLayout.classList.remove('active'); adminLoginScreen.classList.add('active');
                adminLoginForm?.reset();
            }
            showLoading(false);
        });
        adminLoginForm?.addEventListener('submit', async (e) => {
            e.preventDefault(); showLoading(); if(adminLoginError) adminLoginError.style.display = 'none';
            const email = adminLoginEmailInput.value; const password = adminLoginPasswordInput.value;
            if (!email || !password) { if(adminLoginError){ adminLoginError.textContent = "Email and Password are required."; adminLoginError.style.display = 'block';} showLoading(false); return; }
            try { await signInWithEmailAndPassword(auth, email, password); /* onAuthStateChanged will handle UI */ }
            catch (error) {
                if(adminLoginError) {
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') adminLoginError.textContent = "Invalid admin credentials.";
                    else if (error.code === 'auth/too-many-requests') adminLoginError.textContent = "Access temporarily disabled. Try again later.";
                    else adminLoginError.textContent = `Login Failed. Please check credentials.`;
                    adminLoginError.style.display = 'block';
                }
                console.error("Admin Login Error:", error);
            }
            showLoading(false);
        });
        adminLogoutBtn?.addEventListener('click', async () => { showLoading(); try { await firebaseSignOut(auth); } catch (e) { showToast(`Logout Failed: ${e.message}`, 3000, 'error'); showLoading(false); }});
        adminNavTabs.forEach(tab => { tab.addEventListener('click', () => switchSection(tab.dataset.section)); });

        // --- User Management (Realtime with onSnapshot) ---
        function loadUsersWithListener() {
            if (listeners.users) listeners.users(); 
            showLoading();
            if(!usersTableBody) { showLoading(false); return; }
            usersTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Loading users...</td></tr>';
            
            const usersRef = query(collection(db, "users"), orderBy("createdAt", "desc"));
            listeners.users = onSnapshot(usersRef, (querySnapshot) => {
                let users = []; querySnapshot.forEach(doc => users.push({ id: doc.id, ...doc.data() }));
                const searchTerm = userSearchInput ? userSearchInput.value.toLowerCase() : '';
                if (searchTerm) { users = users.filter(u => u.fullName?.toLowerCase().includes(searchTerm) || u.email?.toLowerCase().includes(searchTerm) || u.id.toLowerCase().includes(searchTerm)); }
                renderUsersTable(users);
                showLoading(false);
            }, (error) => { 
                console.error("Users listener error:", error); 
                if(usersTableBody) usersTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Error loading users. Check console.</td></tr>';
                showToast("Error loading users.", 3000, "error"); showLoading(false); 
            });
        }
        userSearchInput?.addEventListener('input', () => loadUsersWithListener()); // Re-attach listener to re-fetch and filter (can be optimized)

        function renderUsersTable(users) { 
            if(!usersTableBody) return; usersTableBody.innerHTML = '';
            if (users.length === 0) { usersTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No users found.</td></tr>'; return; }
            users.forEach(user => {
                const row = usersTableBody.insertRow();
                row.innerHTML = `<td>${user.id.substring(0,8)}..</td><td>${user.fullName||'N/A'}</td><td>${user.email}</td><td>${user.mobile||'N/A'}</td><td><span class="status-pill ${user.isBlocked ? 'blocked' : 'active'}">${user.isBlocked ? 'Blocked' : 'Active'}</span></td>
                <td class="action-buttons-group"><button class="action-btn btn-info" onclick="viewUserDetails('${user.id}')">Details</button><button class="action-btn ${user.isBlocked ? 'btn-success' : 'btn-warn'}" onclick="toggleUserBlockStatus('${user.id}', ${user.isBlocked ?? false})">${user.isBlocked ? 'Unblock' : 'Block'}</button></td>`;
            });
        }
        window.viewUserDetails = async (userId) => {
            showLoading();
            try {
                const userDocSnap = await getDoc(doc(db, "users", userId));
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    let detailsHtml = `<div class="detail-grid">
                        <div class="detail-item"><p><strong>UID:</strong> ${userId}</p></div>
                        <div class="detail-item"><p><strong>Full Name:</strong> ${userData.fullName || 'N/A'}</p></div>
                        <div class="detail-item"><p><strong>Email:</strong> ${userData.email}</p></div>
                        <div class="detail-item"><p><strong>Mobile:</strong> ${userData.mobile || 'N/A'}</p></div>
                        <div class="detail-item"><p><strong>Birth Year:</strong> ${userData.birthYear || 'N/A'}</p></div>
                        <div class="detail-item"><p><strong>Gender:</strong> ${userData.gender || 'N/A'}</p></div>
                        <div class="detail-item"><p><strong>Joined:</strong> ${userData.createdAt?.toDate().toLocaleDateString() || 'N/A'}</p></div>
                        <div class="detail-item"><p><strong>Status:</strong> ${userData.isBlocked ? 'Blocked' : 'Active'}</p></div>
                        ${userData.isBlocked && userData.blockReason ? `<div class="detail-item" style="grid-column: 1 / -1;"><p><strong>Block Reason:</strong> ${userData.blockReason}</p></div>` : ''}
                    </div>`;
                    openModal(`User Details: ${userData.fullName || userId.substring(0,8)}`, detailsHtml);
                } else { showToast("User not found.", 3000, 'error'); }
            } catch (error) { console.error("View user details error:", error); showToast("Error fetching user details.", 3000, 'error'); }
            showLoading(false);
        };
        window.toggleUserBlockStatus = async (userId, isCurrentlyBlocked) => { /* ... (Complete dual write logic from previous admin panel response) ... */ };

        // --- Loan Requests (getDocs, DUAL WRITE for actions) ---
        async function loadLoanRequests() { /* ... (Complete logic from previous admin panel response, fetching from Firestore) ... */ }
        loanRequestSearchInput?.addEventListener('input', loadLoanRequests);
        loanStatusFilter?.addEventListener('change', loadLoanRequests);
        onlyPendingReviewFilter?.addEventListener('change', loadLoanRequests);
        function renderLoanRequestsTable(requests) { /* ... (Complete logic, ensure paymentTransactionId is rendered) ... */ }
        window.viewLoanRequestDetails = async (loanId) => { /* ... (Complete logic, modal shows all loan fields including paymentTransactionId) ... */ };
        window.processLoanAction = async (loanId, action) => { /* ... (Complete logic with form for approval/rejection, DUAL WRITE to Firestore and RTDB) ... */ };
        
        // --- Active Loans & Blocked Users (getDocs) ---
        async function loadActiveLoans() { /* ... (Complete logic) ... */ }
        activeLoanSearchInput?.addEventListener('input', loadActiveLoans);
        function renderActiveLoansTable(loans) { /* ... (Complete logic) ... */ }
        async function loadBlockedUsers() { /* ... (Complete logic) ... */ }
        blockedUserSearchInput?.addEventListener('input', loadBlockedUsers);
        function renderBlockedUsersTable(users) { /* ... (Complete logic) ... */ }

        // --- Payment Methods (RTDB Realtime) ---
        function loadPaymentMethodsWithListener() { /* ... (Complete logic using onValue for 'appConfig/paymentMethods') ... */ }
        upiIdInput?.addEventListener('input', () => { if(previewUpiId && upiIdInput) previewUpiId.textContent = upiIdInput.value || 'Not set'; });
        bankDetailsInput?.addEventListener('input', () => { if(previewBankDetails && bankDetailsInput) previewBankDetails.textContent = bankDetailsInput.value || 'Not set'; });
        paymentMethodsForm?.addEventListener('submit', async (e) => { /* ... (Complete logic saving to RTDB 'appConfig/paymentMethods') ... */ });
        
        // --- Support Requests (RTDB Realtime) ---
        let supportRequestsData = [];
        function loadSupportRequestsWithListener() { /* ... (Complete logic using onValue for RTDB 'supportRequests') ... */ }
        function filterAndRenderSupportRequests() { /* ... (Client-side filter of supportRequestsData) ... */ }
        supportSearchInput?.addEventListener('input', filterAndRenderSupportRequests);
        unreadByAdminFilter?.addEventListener('change', filterAndRenderSupportRequests);
        function renderSupportRequestsTable(requests) { /* ... (Render table, use status-pill) ... */ }
        window.openAdminSupportChat = (userId, userName) => { /* ... (Open modal, loadAdminChatMessages, handle sending messages to RTDB 'supportChats' and updating 'supportRequests') ... */ };
        function loadAdminChatMessages(userId) { /* ... (Listen to RTDB 'supportChats/{userId}') ... */ }
        function displayAdminChatMessage(sender, text, timestamp, area) { /* ... (Render individual chat message) ... */ }
        
    </script>
</body>
</html>