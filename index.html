<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Quids - Admin Panel</title>
    <style>
        :root {
            --primary-color: #5F259F;
            --primary-color-rgb: 95, 37, 159;
            --primary-light: #7E57C2; 
            --accent-color: #FFD700; 
            --content-bg: #F4F6FC;
            --card-bg: #FFFFFF;
            --text-color: #333D49;
            --text-light: #6C757D;
            --text-on-primary: #FFFFFF;
            --success-color: #28A745;
            --error-color: #DC3545;
            --border-color: #E0E0E0;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
            --font-family: 'Roboto', 'Segoe UI', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            background-color: var(--content-bg);
            color: var(--text-color);
            font-size: 15px;
            line-height: 1.5;
        }

        /* Login Screen */
        .admin-login-container { display: flex; justify-content: center; align-items: center; width: 100%; min-height: 100vh; background: var(--primary-color); }
        .login-box { background-color: var(--card-bg); padding: 30px 35px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .login-box h1 { color: var(--primary-color); font-size: 1.8em; margin-bottom: 25px; font-weight: 700; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; font-size: 0.9em; font-weight: 500; color: var(--text-light); margin-bottom: 8px; }
        .form-group input { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; color: var(--text-color); }
        .form-group input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.2); }
        .btn { display: inline-block; padding: 12px 25px; background: var(--primary-color); color: var(--text-on-primary); border: none; border-radius: 8px; font-size: 1em; font-weight: 500; cursor: pointer; text-align: center; transition: background-color 0.2s ease, transform 0.1s ease; }
        .btn:hover { background-color: var(--primary-color-dark); }
        .btn:active { transform: scale(0.98); }
        #adminLoginError { color: var(--error-color); font-size: 0.9em; margin-top: 15px; display: none; }

        /* Admin Dashboard Layout */
        .admin-dashboard-layout { width: 100%; min-height: 100vh; display:flex; flex-direction:column; }
        .admin-top-header { background-color: var(--primary-color); padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        .admin-top-header h1 { font-size: 1.4em; color: var(--text-on-primary); margin: 0; font-weight: 500; }
        #adminLogoutBtn { background-color: rgba(255,255,255,0.2); color: var(--text-on-primary); padding: 7px 15px; font-size: 0.9em; border-radius: 6px; }
        #adminLogoutBtn:hover { background-color: rgba(255,255,255,0.3); }

        .admin-nav-tabs { display: flex; background-color: var(--primary-color-dark); box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow-x: auto; }
        .admin-nav-tab { padding: 12px 18px; color: rgba(255,255,255,0.75); cursor: pointer; font-weight: 500; border-bottom: 3px solid transparent; transition: color 0.2s, border-bottom-color 0.2s, background-color 0.2s; white-space: nowrap; font-size: 0.9em; }
        .admin-nav-tab:hover { background-color: var(--primary-light); color: var(--text-on-primary); }
        .admin-nav-tab.active { color: var(--text-on-primary); border-bottom-color: var(--accent-color); background-color: var(--primary-light); font-weight: 600; }

        .admin-main-content { padding: 25px; flex-grow: 1; }
        .admin-section { display: none; animation: fadeInContent 0.3s ease-out; }
        .admin-section.active { display: block; }
        @keyframes fadeInContent { from{opacity:0; transform: translateY(5px);} to{opacity:1; transform:translateY(0);} }
        .section-title-header { font-size: 1.7em; color: var(--primary-color); margin-bottom: 20px; font-weight: 600; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        
        .filters-bar { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; padding: 15px; background-color:var(--card-bg); border-radius:8px; box-shadow: var(--shadow); }
        .filters-bar input[type="text"], .filters-bar select { padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9em; flex-grow:1; }
        .filters-bar label { display: flex; align-items: center; font-size: 0.9em; } .filters-bar input[type="checkbox"] { margin-right: 5px; }

        .table-container { background-color: var(--card-bg); border-radius: 8px; box-shadow: var(--shadow); overflow-x:auto; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .data-table th, .data-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle;}
        .data-table thead th { background-color: #F1F3F5; color: var(--text-light); font-weight: 500; font-size: 0.85em; text-transform: uppercase; }
        .data-table tbody tr:hover { background-color: #f8f9fa; }
        .action-btn { padding: 5px 10px; font-size:0.8em; margin-right:5px; border-radius:5px; cursor:pointer; border:1px solid transparent; color:white; }
        .btn-info { background-color: var(--info-color); } .btn-info:hover { background-color: #138496;}
        .btn-success { background-color: var(--success-color); } .btn-success:hover { background-color: #1e7e34;}
        .btn-danger { background-color: var(--error-color); } .btn-danger:hover { background-color: #bd2130;}
        .btn-warn { background-color: var(--warn-color); color:var(--text-color);} .btn-warn:hover { background-color: #e0a800;}

        .status-pill { padding: 3px 8px; border-radius: 15px; font-size: 0.8em; font-weight: 500; display: inline-block; text-align: center; min-width: 80px; }
        .status-pill.active, .status-pill.approved { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;}
        .status-pill.blocked, .status-pill.rejected { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
        .status-pill.under-process { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;}

        .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--card-bg); margin: auto; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 100%; max-width: 700px; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .modal-header h3 { margin: 0; color: var(--primary-color); font-size: 1.3em; font-weight: 600; }
        .modal-close-btn { font-size: 1.8em; font-weight: bold; color: var(--text-light); background: none; border: none; cursor: pointer; line-height: 1; padding: 5px; }
        .modal-close-btn:hover { color: var(--text-color); }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px 20px; font-size:0.95em; }
        .detail-item p { margin-bottom: 7px; } .detail-item strong { font-weight: 500; color: var(--text-light); margin-right:5px; }
        #adminSupportChatView { display: flex; flex-direction: column; height: 60vh; }
        #adminChatMessagesArea { flex-grow: 1; overflow-y: auto; padding: 15px; background-color: var(--content-bg); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px; }
        #adminChatForm { display: flex; align-items: center; }
        #adminChatMessageInput { flex-grow: 1; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 20px; margin-right: 10px; font-size: 0.95em; }
        #adminChatForm button { padding: 10px 15px; border-radius: 20px; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; display: none; backdrop-filter: blur(2px); }
        .loading-spinner { border: 5px solid rgba(var(--primary-color-rgb),0.2); border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast-notification { position: fixed; top: 20px; right: 20px; background-color: var(--text-color); color: var(--text-on-primary); padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); z-index: 10000; font-size: 0.9em; opacity: 0; transform: translateY(-20px) ; transition: opacity 0.3s ease, transform 0.3s ease; }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .toast-notification.success { background-color: var(--success-color); } .toast-notification.error { background-color: var(--error-color); } .toast-notification.info { background-color: var(--info-color); }
        
        /* Admin Form Specific Styling */
        .admin-form { padding-top: 10px; }
        .admin-form .form-group label {color: var(--text-light); font-weight:400;}
        .admin-form textarea { min-height: 80px; }

        @media (max-width: 768px) {
            .admin-nav-tabs { font-size: 0.85em; }
            .admin-nav-tab { padding: 12px 10px; }
            .admin-main-content { padding: 15px; }
            .section-title-header { font-size: 1.5em; }
            .filters-bar { flex-direction: column; gap: 10px; }
            .filters-bar input[type="text"], .filters-bar select { width:100%;}
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="adminLoginScreen" class="admin-login-container screen active">
        <div class="login-box">
            <h1>Admin Panel</h1>
            <form id="adminLoginForm">
                <div class="form-group"><label for="adminLoginEmail">Email Address</label><input type="email" id="adminLoginEmail" required autocomplete="username"></div>
                <div class="form-group"><label for="adminLoginPassword">Password</label><input type="password" id="adminLoginPassword" required autocomplete="current-password"></div>
                <button type="submit" class="btn" style="width:100%;">Login</button>
                <p id="adminLoginError"></p>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard Layout -->
    <div id="adminDashboardLayout" class="admin-dashboard-layout screen">
        <header class="admin-top-header">
            <h1>Quick Quids Admin</h1>
            <button id="adminLogoutBtn" class="btn">Logout</button>
        </header>
        <nav class="admin-nav-tabs" id="adminNavTabs">
            <span class="admin-nav-tab active" data-section="usersSection">Users</span>
            <span class="admin-nav-tab" data-section="loanRequestsSection">Loan Requests</span>
            <span class="admin-nav-tab" data-section="activeLoansSection">Active Loans</span>
            <span class="admin-nav-tab" data-section="blockedUsersSection">Blocked Users</span>
            <span class="admin-nav-tab" data-section="paymentMethodsSection">Payment Methods</span>
            <span class="admin-nav-tab" data-section="supportRequestsSection">Support Requests</span>
        </nav>
        <main class="admin-main-content">
            <section id="usersSection" class="admin-section active">
                <h2 class="section-title-header">User Management</h2>
                <div class="filters-bar"><input type="text" id="userSearchInput" placeholder="Search by Name, Email, UID..."></div>
                <div class="table-container"><table class="data-table" id="usersTable"><thead><tr><th>UID</th><th>Full Name</th><th>Email</th><th>Mobile</th><th>Status</th><th>Actions</th></tr></thead><tbody><tr><td colspan="6" style="text-align:center; padding:20px;">Loading users...</td></tr></tbody></table></div>
            </section>
            <section id="loanRequestsSection" class="admin-section">
                <h2 class="section-title-header">Loan Application Requests</h2>
                <div class="filters-bar"><input type="text" id="loanRequestSearchInput" placeholder="Search by Applicant, Loan ID..."><select id="loanStatusFilter"><option value="all">All Statuses</option><option value="Under Process">Under Process</option><option value="Approved">Approved</option><option value="Rejected">Rejected</option></select><label><input type="checkbox" id="onlyPendingReviewFilter"> Only Pending Review</label></div>
                <div class="table-container"><table class="data-table" id="loanRequestsTable"><thead><tr><th>Loan ID</th><th>Applicant</th><th>Type</th><th>Amount (₹)</th><th>Fee TxID</th><th>Applied</th><th>Status</th><th>Actions</th></tr></thead><tbody><tr><td colspan="8" style="text-align:center; padding:20px;">Loading requests...</td></tr></tbody></table></div>
            </section>
            <section id="activeLoansSection" class="admin-section">
                <h2 class="section-title-header">Active Loans Monitoring</h2>
                <div class="filters-bar"><input type="text" id="activeLoanSearchInput" placeholder="Search by Applicant, Loan ID..."></div>
                <div class="table-container"><table class="data-table" id="activeLoansTable"><thead><tr><th>Loan ID</th><th>Applicant</th><th>Type</th><th>Approved (₹)</th><th>EMI/Total (₹)</th><th>Next Due</th><th>Overall Status</th></tr></thead><tbody><tr><td colspan="7" style="text-align:center; padding:20px;">Loading active loans...</td></tr></tbody></table></div>
            </section>
            <section id="blockedUsersSection" class="admin-section">
                <h2 class="section-title-header">Blocked Users</h2>
                <div class="filters-bar"><input type="text" id="blockedUserSearchInput" placeholder="Search by Name, Email, UID..."></div>
                <div class="table-container"><table class="data-table" id="blockedUsersTable"><thead><tr><th>UID</th><th>Full Name</th><th>Email</th><th>Reason</th><th>Actions</th></tr></thead><tbody><tr><td colspan="5" style="text-align:center; padding:20px;">Loading blocked users...</td></tr></tbody></table></div>
            </section>
            <section id="paymentMethodsSection" class="admin-section">
                <h2 class="section-title-header">Payment Method Configuration</h2>
                <form id="paymentMethodsForm" class="admin-form" style="max-width:600px; background:var(--card-bg); padding:20px; border-radius:8px; box-shadow:var(--shadow);">
                    <p style="color:var(--text-light); font-size:0.9em; margin-bottom:15px;">These details appear on the user panel for processing fee payment.</p>
                    <div class="form-group"><label for="upiIdInput">UPI ID</label><input type="text" id="upiIdInput" required></div>
                    <div class="form-group"><label for="bankDetailsInput">Bank Account Details (Acct Name, Number, IFSC)</label><textarea id="bankDetailsInput" rows="3" required></textarea></div>
                    <button type="submit" class="btn">Save Payment Methods</button>
                    <div id="paymentMethodsPreview" style="margin-top:20px; padding:15px; background-color:#f8f9fa; border:1px dashed var(--border-color); border-radius:8px;">
                        <h4 style="margin-bottom:10px; font-weight:500;">Preview (User View):</h4>
                        <p><strong>UPI:</strong> <span id="previewUpiId">Not set</span></p>
                        <p><strong>Bank:</strong> <span id="previewBankDetails">Not set</span></p>
                    </div>
                </form>
            </section>
            <section id="supportRequestsSection" class="admin-section">
                <h2 class="section-title-header">Customer Support Requests</h2>
                <div class="filters-bar"><input type="text" id="supportSearchInput" placeholder="Search by User Name, User ID..."><label><input type="checkbox" id="unreadByAdminFilter"> Only Unread by Admin</label></div>
                <div class="table-container"><table class="data-table" id="supportRequestsTable"><thead><tr><th>User Name</th><th>Last Message</th><th>Timestamp</th><th>Status</th><th>Actions</th></tr></thead><tbody><tr><td colspan="5" style="text-align:center; padding:20px;">Loading support requests...</td></tr></tbody></table></div>
            </section>
        </main>
    </div>

    <div id="adminModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 id="adminModalTitle"></h3><button class="modal-close-btn" id="adminModalCloseBtn">&times;</button></div><div id="adminModalBody"></div></div></div>
    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>
    <div class="toast-notification" id="toastNotification"></div>

    <script type="module">
        // Firebase SDK Imports (Same as before)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut as firebaseSignOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, query, where, orderBy, Timestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";
        import { getDatabase, ref, get, set, push, onValue, serverTimestamp, query as rtdbQuery, orderByChild as rtdbOrderByChild, update as rtdbUpdate } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5lWYt4OTJLwWCrcBFs2YuFjMSGBfmWFs", authDomain: "quickquids1.firebaseapp.com",
            databaseURL: "https://quickquids1-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "quickquids1",
            storageBucket: "quickquids1.firebasestorage.app", messagingSenderId: "536263689144",
            appId: "1:536263689144:web:276640940106438cf8454d", measurementId: "G-7SEB49V2LL"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        // DOM Elements (Ensure ALL are selected correctly)
        // ... (Copy all const declarations from the MOST RECENT full admin_panel.html JavaScript I provided)
        const adminLoginScreen = document.getElementById('adminLoginScreen');
        // ... etc. for all other elements ...

        let currentAdminUser = null;
        let currentOpenSection = 'usersSection'; 
        let listeners = { users: null, paymentMethods: null, supportRequests: null, currentChat: null, loanRequests: null, activeLoans:null, blockedUsers:null };

        // --- ALL JAVASCRIPT FUNCTIONS (Utility, Auth, Navigation, User Management, Loan Requests, etc.) ---
        // COPY THE ENTIRE JAVASCRIPT LOGIC (all functions and event listeners)
        // FROM THE PREVIOUS ADMIN PANEL RESPONSE WHERE I PROVIDED THE FULL JS FOR
        // THE "ORIGINAL-INSPIRED DESIGN" (THE ONE WITH SIDEBAR AND CARDS, 
        // which was the immediate predecessor to the one where I tried to match your screenshot).
        // Adjust `adminNavItems` to `adminNavTabs` in `switchSection` and its event listener.
        // Ensure `currentSectionTitleEl` is not used if titles are in section headers.

        // Example of how the switchSection would look with adminNavTabs:
        /*
        function switchSection(sectionId) {
            cleanupListeners(); 
            currentOpenSection = sectionId;
            adminSections.forEach(s => s.classList.remove('active'));
            const targetSection = document.getElementById(sectionId);
            if(targetSection) targetSection.classList.add('active');

            adminNavTabs.forEach(tab => tab.classList.remove('active')); // Use adminNavTabs
            const activeTab = document.querySelector(`.admin-nav-tab[data-section="${sectionId}"]`);
            if(activeTab) activeTab.classList.add('active');
            
            // Load data for the section
            if (sectionId === 'usersSection') loadUsersWithListener();
            // ... other sections
        }
        adminNavTabs.forEach(tab => { 
            tab.addEventListener('click', () => switchSection(tab.dataset.section)); 
        });
        */

        // PASTE THE FULL JS LOGIC (FROM PREVIOUS COMPLETE ADMIN PANEL) HERE
        // Make sure to adapt any sidebar specific logic to the new tab navigation if needed.
        // The core data loading and rendering functions should largely remain the same.
        // Pay special attention to the DUAL WRITE logic in `toggleUserBlockStatus` and `processLoanAction`.
        // Ensure `renderLoanRequestsTable` includes the 'Fee TxID'.
        // Ensure `viewLoanRequestDetails` modal HTML shows the 'Fee TxID'.

    </script>
</body>
</html>